<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel Cocina y Caja - Mia's Sugar</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --rosa: #ad1457; --fondo: #fce4ec; --amarillo: #fff9c4; --verde: #2e7d32; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--fondo); padding: 20px; margin: 0; padding-bottom: 100px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: var(--rosa); margin: 0; }
        .grid { display: flex; flex-wrap: wrap; gap: 20px; }
        .tarjeta { background: white; border-radius: 15px; width: 300px; box-shadow: 0 6px 15px rgba(0,0,0,0.1); border-top: 10px solid var(--rosa); display: flex; flex-direction: column; position: relative; }
        .t-contenido { padding: 20px; flex-grow: 1; }
        h3 { margin-top: 0; color: #333; border-bottom: 2px solid var(--fondo); padding-bottom: 5px; }
        ul { padding-left: 20px; margin: 15px 0; }
        li { margin-bottom: 5px; font-weight: 500; color: #444; }
        .notas-cliente { background: var(--amarillo); padding: 10px; border-radius: 8px; font-size: 0.85em; margin-top: 10px; border-left: 4px solid #fbc02d; }
        .total-pago { font-size: 1.2em; font-weight: bold; color: var(--verde); text-align: right; }
        
        /* BOTONES */
        .btn-anular { position: absolute; top: 10px; right: 10px; background: #eee; color: #666; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 1.2em; }
        .btn-anular:hover { background: #ffcdd2; color: #c62828; }
        .btn-cobrar { background: var(--verde); color: white; border: none; width: 100%; padding: 18px; font-weight: bold; cursor: pointer; border-radius: 0 0 15px 15px; }
        
        /* BARRA DE CAJA INFERIOR */
        .barra-caja { position: fixed; bottom: 0; left: 0; width: 100%; background: #333; color: white; padding: 20px; box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; z-index: 1000; box-shadow: 0 -5px 10px rgba(0,0,0,0.2); }
        .caja-info h2 { margin: 0; font-size: 1.5em; color: #81c784; }
        .btn-reset-caja { background: #555; color: #ccc; border: 1px solid #777; padding: 8px; border-radius: 5px; cursor: pointer; font-size: 0.8em; }
    </style>
</head>
<body>

    <div class="header">
        <h1>üë®‚Äçüç≥ Mia's Sugar - Cocina</h1>
        <button onclick="if(confirm('¬øBorrar TODO?')) db.ref('pedidos').remove()" style="background:#c62828; color:white; border:none; padding:10px; border-radius:8px; cursor:pointer;">‚ö†Ô∏è LIMPIAR PANTALLA</button>
    </div>

    <div id="contenedor" class="grid"></div>

    <div class="barra-caja">
        <div class="caja-info">
            <span>TOTAL CAJA DEL D√çA:</span>
            <h2 id="suma-caja">0.00‚Ç¨</h2>
        </div>
        <button class="btn-reset-caja" onclick="resetCaja()">Cerrar Caja (Reiniciar)</button>
    </div>

    <audio id="sonidoTimbre" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

<script>
    const firebaseConfig = { databaseURL: "https://mia-s-sugar-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let cantidadAnterior = 0;

    // 1. ESCUCHAR PEDIDOS ACTIVOS Y CAJA
    db.ref().on('value', (snapshot) => {
        const base = snapshot.val() || {};
        const pedidos = base.pedidos || {};
        const historial = base.caja_diaria || {};
        
        // --- Actualizar Caja ---
        let totalDia = 0;
        Object.values(historial).forEach(v => totalDia += parseFloat(v.total || 0));
        document.getElementById('suma-caja').innerText = totalDia.toFixed(2) + "‚Ç¨";

        // --- Renderizar Comandas ---
        const cont = document.getElementById('contenedor');
        cont.innerHTML = "";
        
        const ids = Object.keys(pedidos);
        if (ids.length > cantidadAnterior) {
            document.getElementById('sonidoTimbre').play().catch(() => {});
        }
        cantidadAnterior = ids.length;

        const mesas = {};
        ids.forEach(id => {
            const p = pedidos[id];
            const m = p.ubicacion;
            if (!mesas[m]) mesas[m] = { prod: [], total: 0, notas: [], ids: [] };
            mesas[m].prod.push(...p.productos);
            mesas[m].total += parseFloat(p.total);
            if(p.detalles) mesas[m].notas.push(p.detalles);
            mesas[m].ids.push(id);
        });

        Object.keys(mesas).forEach(m => {
            const data = mesas[m];
            const div = document.createElement('div');
            div.className = 'tarjeta';
            div.innerHTML = `
                <button class="btn-anular" title="Anular pedido" onclick="anularMesa('${m}')">‚àí</button>
                <div class="t-contenido">
                    <h3>${m}</h3>
                    <ul>${data.prod.map(p => `<li>${p}</li>`).join('')}</ul>
                    ${data.notas.length > 0 ? `<div class="notas-cliente"><b>Notas:</b><br>${data.notas.join(' | ')}</div>` : ''}
                    <div class="total-pago">${data.total.toFixed(2)}‚Ç¨</div>
                </div>
                <button class="btn-cobrar" onclick="cobrarMesa('${m}', ${data.total})">‚úÖ COBRAR</button>
            `;
            cont.appendChild(div);
        });
    });

    // 2. FUNCI√ìN COBRAR (Suma a la caja y quita de pantalla)
    function cobrarMesa(nombre, totalMesa) {
        // A√±adimos al historial de caja primero
        db.ref('caja_diaria').push({
            mesa: nombre,
            total: totalMesa,
            hora: new Date().toLocaleTimeString()
        }).then(() => {
            // Luego quitamos de pedidos activos
            eliminarDeActivos(nombre);
        });
    }

    // 3. FUNCI√ìN ANULAR (Solo quita de pantalla, NO suma a caja)
    function anularMesa(nombre) {
        if (confirm(`¬øAnular pedido de ${nombre}? No se sumar√° a la caja.`)) {
            eliminarDeActivos(nombre);
        }
    }

    function eliminarDeActivos(nombreMesa) {
        db.ref('pedidos').once('value', (snap) => {
            const peds = snap.val();
            for (let id in peds) {
                if (peds[id].ubicacion === nombreMesa) db.ref('pedidos/' + id).remove();
            }
        });
    }

    // 4. REINICIAR CAJA (Para empezar el d√≠a de cero)
    function resetCaja() {
        if (confirm("¬øCerrar caja? Se borrar√° el total acumulado para empezar un nuevo turno/d√≠a.")) {
            db.ref('caja_diaria').remove();
        }
    }
</script>
</body>
</html>
