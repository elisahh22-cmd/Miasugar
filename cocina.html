<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mia's Sugar - Control de Cocina</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --primario: #ad1457; --secundario: #fce4ec; --exito: #2e7d32; --peligro: #c62828; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--secundario); margin: 0; padding: 20px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: var(--primario); margin: 0; font-size: 1.5rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .tarjeta { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-top: 6px solid var(--primario); display: flex; flex-direction: column; }
        .t-header { padding: 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .t-mesa { font-weight: bold; font-size: 1.2rem; color: var(--primario); }
        .t-total { font-weight: bold; font-size: 1.1rem; color: var(--exito); }
        .t-cuerpo { padding: 15px; flex-grow: 1; }
        .t-lista { margin: 0; padding-left: 20px; color: #444; }
        .t-nota { margin-top: 15px; padding: 10px; background: #fff9c4; border-radius: 8px; font-size: 0.85rem; border-left: 4px solid #fbc02d; }
        .btn-accion { padding: 12px; border: none; cursor: pointer; font-weight: bold; font-size: 1rem; transition: 0.3s; }
        .btn-cerrar { background-color: var(--exito); color: white; width: 100%; }
        .btn-cerrar:hover { background-color: #1b5e20; }
        .btn-borrar-todo { background: var(--peligro); color: white; border-radius: 8px; padding: 10px 20px; }
        .empty { text-align: center; grid-column: 1/-1; padding: 50px; color: #888; }
    </style>
</head>
<body>

    <div class="top-bar">
        <h1>üë®‚Äçüç≥ Mia's Sugar - COCINA</h1>
        <button class="btn-borrar-todo" onclick="borrarBaseDatos()">‚ö†Ô∏è LIMPIAR TODA LA BASE</button>
    </div>

    <div id="panel-cocina" class="grid">
        <div class="empty">Cargando pedidos...</div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://mia-s-sugar-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Funci√≥n para refrescar la pantalla
    db.ref('pedidos').on('value', (snapshot) => {
        const data = snapshot.val();
        const contenedor = document.getElementById('panel-cocina');
        contenedor.innerHTML = "";

        if (!data) {
            contenedor.innerHTML = '<div class="empty">No hay pedidos pendientes. ¬°Todo al d√≠a! ‚ú®</div>';
            return;
        }

        const mesasAgrupadas = {};

        // Agrupamos por ubicaci√≥n y filtramos solo los que NO est√°n cobrados
        Object.keys(data).forEach(id => {
            const p = data[id];
            if (p.estado !== "Cobrado") {
                const mesaKey = p.ubicacion || "Sin Mesa";
                if (!mesasAgrupadas[mesaKey]) {
                    mesasAgrupadas[mesaKey] = { productos: [], total: 0, notas: [], ids: [] };
                }
                mesasAgrupadas[mesaKey].productos.push(...p.productos);
                mesasAgrupadas[mesaKey].total += parseFloat(p.total || 0);
                if (p.detalles) mesasAgrupadas[mesaKey].notas.push(p.detalles);
                mesasAgrupadas[mesaKey].ids.push(id);
            }
        });

        // Generar las tarjetas
        Object.keys(mesasAgrupadas).forEach(nombreMesa => {
            const m = mesasAgrupadas[nombreMesa];
            const div = document.createElement('div');
            div.className = 'tarjeta';
            div.innerHTML = `
                <div class="t-header">
                    <span class="t-mesa">${nombreMesa}</span>
                    <span class="t-total">${m.total.toFixed(2)}‚Ç¨</span>
                </div>
                <div class="t-cuerpo">
                    <ul class="t-lista">${m.productos.map(pr => `<li>${pr}</li>`).join('')}</ul>
                    ${m.notas.length > 0 ? `<div class="t-nota"><strong>Notas:</strong> ${m.notas.join(' | ')}</div>` : ''}
                </div>
                <button class="btn-accion btn-cerrar" onclick="cerrarMesa('${nombreMesa}', ${JSON.stringify(m.ids)})">
                    COBRAR Y QUITAR
                </button>
            `;
            contenedor.appendChild(div);
        });
    });

    // FUNCI√ìN PARA CERRAR (ACTUALIZA ESTADO A COBRADO)
    function cerrarMesa(nombre, ids) {
        if (confirm(`¬øFinalizar la ${nombre}? Se guardar√° como cobrada.`)) {
            const actualizaciones = {};
            ids.forEach(id => {
                actualizaciones['/pedidos/' + id + '/estado'] = "Cobrado";
            });
            
            db.ref().update(actualizaciones)
                .then(() => console.log("Mesa cerrada"))
                .catch(err => alert("Error al cerrar: " + err));
        }
    }

    // BOT√ìN DE P√ÅNICO: Borra f√≠sicamente todos los pedidos de la base
    function borrarBaseDatos() {
        if (confirm("‚ö†Ô∏è ESTO BORRAR√Å TODOS LOS PEDIDOS DE LA HISTORIA. ¬øEst√°s seguro?")) {
            db.ref('pedidos').remove()
                .then(() => alert("Base de datos vaciada correctamente."))
                .catch(err => alert("Error: " + err));
        }
    }
</script>
</body>
</html>
